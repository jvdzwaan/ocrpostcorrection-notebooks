schema: '2.0'
stages:
  data-split:
    cmd: python src/stages/data-split.py --config params.yaml
    deps:
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: src/stages/data-split.py
      md5: d1bc7ed746535b3745e64345810d414e
      size: 1353
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        data-split:
          val-size: 0.1
          train-split: data/splits/train.csv
          val-split: data/splits/val.csv
          test-split: data/splits/test.csv
    outs:
    - path: data/splits/test.csv
      md5: 12b4e9253147e46207a934aa0988e15e
      size: 163439
    - path: data/splits/train.csv
      md5: 4e3d17d9ef2abdf7debb09b7184d19f1
      size: 574230
    - path: data/splits/val.csv
      md5: 481d6c2885fa9f6aa7805c0100cb32e6
      size: 63904
  create-error-detection-dataset:
    cmd: python src/stages/create-error-detection-dataset.py --config params.yaml
    deps:
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: data/splits/test.csv
      md5: 12b4e9253147e46207a934aa0988e15e
      size: 163439
    - path: data/splits/train.csv
      md5: 4e3d17d9ef2abdf7debb09b7184d19f1
      size: 574230
    - path: data/splits/val.csv
      md5: 481d6c2885fa9f6aa7805c0100cb32e6
      size: 63904
    - path: src/stages/create-error-detection-dataset.py
      md5: 71bcecd7f786dda1e8a30f51377e6d54
      size: 2738
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-detection-dataset:
          size: 35
          step: 30
          max-edit-distance: 0.3
          dataset: data/processed/detection-dataset
    outs:
    - path: data/processed/detection-dataset
      md5: 649d31b769a41e287af7e069efcf8f54.dir
      size: 77550059
      nfiles: 10
  train-error-detection:
    cmd: python src/stages/train-error-detection.py --config params.yaml
    deps:
    - path: data/processed/detection-dataset
      md5: 649d31b769a41e287af7e069efcf8f54.dir
      size: 77550059
      nfiles: 10
    - path: src/stages/train-error-detection.py
      md5: 38fac49446a37bcf488710d9eb492d24
      size: 3958
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-detection-dataset:
          size: 35
          step: 30
          max-edit-distance: 0.3
          dataset: data/processed/detection-dataset
        train-error-detection:
          pretrained-model-name: bert-base-multilingual-cased
          output-dir: models/error-detection/
          evaluation-strategy: epoch
          num-train-epochs: 3
          load-best-model-at-end: true
          save-strategy: epoch
          per-device-train-batch-size: 16
          train-log: results/detection/logs/train-log.csv
          delete-checkpoints: true
    outs:
    - path: models/error-detection/
      md5: c6ae910b1dde1c6dd1476ba0016ef584.dir
      size: 713052764
      nfiles: 7
    - path: results/detection/logs/train-log.csv
      md5: 18ce9c5204d48f5913664f2fd29e4ff1
      size: 1092
  evaluate-error-detection:
    cmd: python src/stages/run-icdar-evaluation.py data/raw/ICDAR2019_POCR_competition_dataset.zip
      results/detection/icdar_predictions.json results/detection/icdar_evaluation_results.csv
      INFO
    deps:
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: results/detection/icdar_predictions.json
      md5: 1f1295ece1c46384f92aaa6fe1de2c7e
      size: 5172170
    - path: src/stages/run-icdar-evaluation.py
      md5: 36368e053f7968b516715d047e0c7857
      size: 649
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        convert-predictions-to-icdar-output:
          icdar-output-json: results/detection/icdar_predictions.json
        evaluate-error-detection:
          icdar-output-csv: results/detection/icdar_evaluation_results.csv
        predict-test-set-error-detection:
          per-device-eval-batch-size: 16
          test-log: results/detection/logs/test-log.csv
          predictions: results/detection/predictions.npy
    outs:
    - path: results/detection/icdar_evaluation_results.csv
      md5: 7eb61fb367022ea9ca9dffa7d05a048c
      size: 158458
  predict-test-set-error-detection:
    cmd: python src/stages/predict-test-set-error-detection.py --config params.yaml
    deps:
    - path: data/processed/detection-dataset
      md5: 649d31b769a41e287af7e069efcf8f54.dir
      size: 77550059
      nfiles: 10
    - path: models/error-detection/
      md5: c6ae910b1dde1c6dd1476ba0016ef584.dir
      size: 713052764
      nfiles: 7
    - path: src/stages/predict-test-set-error-detection.py
      md5: c2f49ae8c643c94baf0bd101d0e0a461
      size: 2986
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-detection-dataset:
          size: 35
          step: 30
          max-edit-distance: 0.3
          dataset: data/processed/detection-dataset
        predict-test-set-error-detection:
          per-device-eval-batch-size: 16
          test-log: results/detection/logs/test-log.csv
          predictions: results/detection/predictions.npy
        train-error-detection:
          pretrained-model-name: bert-base-multilingual-cased
          output-dir: models/error-detection/
          evaluation-strategy: epoch
          num-train-epochs: 3
          load-best-model-at-end: true
          save-strategy: epoch
          per-device-train-batch-size: 16
          train-log: results/detection/logs/train-log.csv
          delete-checkpoints: true
    outs:
    - path: results/detection/logs/test-log.csv
      md5: 40aced86d4b486aee8dfa00a1f14573c
      size: 95
    - path: results/detection/predictions.npy
      md5: f3b134a9149b2205687ac3e13737d732
      size: 78632336
  generate-error-detection-report:
    cmd: python src/stages/generate-error-detection-report.py --config params.yaml
    deps:
    - path: results/detection/icdar_evaluation_results.csv
      md5: 7eb61fb367022ea9ca9dffa7d05a048c
      size: 158458
    - path: results/detection/logs/test-log.csv
      md5: 40aced86d4b486aee8dfa00a1f14573c
      size: 95
    - path: results/detection/logs/train-log.csv
      md5: 18ce9c5204d48f5913664f2fd29e4ff1
      size: 1092
    - path: src/stages/generate-error-detection-report.py
      md5: 9721c57fc0a83d3336218eea950db930
      size: 2721
    - path: templates/report-error-detection.md
      md5: a6f392d6f73022cf9ef9b35dfa600b74
      size: 633
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-detection-dataset:
          size: 35
          step: 30
          max-edit-distance: 0.3
          dataset: data/processed/detection-dataset
        data-split:
          val-size: 0.1
          train-split: data/splits/train.csv
          val-split: data/splits/val.csv
          test-split: data/splits/test.csv
        evaluate-error-detection:
          icdar-output-csv: results/detection/icdar_evaluation_results.csv
        predict-test-set-error-detection:
          per-device-eval-batch-size: 16
          test-log: results/detection/logs/test-log.csv
          predictions: results/detection/predictions.npy
        train-error-detection:
          pretrained-model-name: bert-base-multilingual-cased
          output-dir: models/error-detection/
          evaluation-strategy: epoch
          num-train-epochs: 3
          load-best-model-at-end: true
          save-strategy: epoch
          per-device-train-batch-size: 16
          train-log: results/detection/logs/train-log.csv
          delete-checkpoints: true
    outs:
    - path: reports/detection/experiment_results.md
      md5: d4e0bd9e1339ff66ce31095ff6f95152
      size: 1520
    - path: reports/detection/metrics.json
      md5: a0ffc36c50a661284c907e4a55d58f27
      size: 329
  convert-predictions-to-icdar-output:
    cmd: python src/stages/convert-predictions-to-icdar-output.py --config params.yaml
    deps:
    - path: data/processed/detection-dataset
      md5: 649d31b769a41e287af7e069efcf8f54.dir
      size: 77550059
      nfiles: 10
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: results/detection/predictions.npy
      md5: f3b134a9149b2205687ac3e13737d732
      size: 78632336
    - path: src/stages/convert-predictions-to-icdar-output.py
      md5: bf628478304b9fb7c3163f3425eef0bf
      size: 1958
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        convert-predictions-to-icdar-output:
          icdar-output-json: results/detection/icdar_predictions.json
        predict-test-set-error-detection:
          per-device-eval-batch-size: 16
          test-log: results/detection/logs/test-log.csv
          predictions: results/detection/predictions.npy
        train-error-detection:
          pretrained-model-name: bert-base-multilingual-cased
          output-dir: models/error-detection/
          evaluation-strategy: epoch
          num-train-epochs: 3
          load-best-model-at-end: true
          save-strategy: epoch
          per-device-train-batch-size: 16
          train-log: results/detection/logs/train-log.csv
          delete-checkpoints: true
    outs:
    - path: results/detection/icdar_predictions.json
      md5: 1f1295ece1c46384f92aaa6fe1de2c7e
      size: 5172170
  create-error-correction-dataset:
    cmd: python src/stages/create-error-correction-dataset.py --config params.yaml
    deps:
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: data/splits/val.csv
      md5: 481d6c2885fa9f6aa7805c0100cb32e6
      size: 63904
    - path: src/stages/create-error-correction-dataset.py
      md5: 415cd200f63847e6cfa927a3fe3e32e1
      size: 1571
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-correction-dataset:
          dataset: data/processed/correction-dataset/dataset.csv
    outs:
    - path: data/processed/correction-dataset/dataset.csv
      md5: 53c8c4d51c5641c39b824f8d485df4ee
      size: 85464812
  train-error-correction:
    cmd: python src/stages/train-error-correction.py --config params.yaml
    deps:
    - path: data/processed/correction-dataset/dataset.csv
      md5: 53c8c4d51c5641c39b824f8d485df4ee
      size: 85464812
    - path: src/stages/train-error-correction.py
      md5: 9a25decd74bdb192de318a55e55d7e95
      size: 7333
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        create-error-correction-dataset:
          dataset: data/processed/correction-dataset/dataset.csv
        train-error-correction:
          max-len: 22
          batch-size: 256
          model-save-path: models/error-correction/model.rar
          hidden-size: 256
          dropout: 0.1
          teacher-forcing-ratio: 0.5
          num-epochs: 25
          valid-niter: 5
          max-num-patience: 5
          max-num-trial: 5
          lr-decay: 0.5
          train-log: results/correction/logs/train-log.csv
    outs:
    - path: models/error-correction/model.rar
      md5: 3250b7368c517f54d8c4ac5a452b463b
      size: 12083233
    - path: results/correction/logs/train-log.csv
      md5: 220ac260dd4578f6a2ab816dd108345d
      size: 1404
  predict-error-correction:
    cmd: "python src/stages/predict-error-correction.py --error-correction-dataset\
      \ data/processed/correction-dataset/dataset.csv --hidden-size 256 --dropout\
      \ 0.1 --max-len 22 --teacher-forcing-ratio 0.5 --model-path models/error-correction/model.rar\
      \ --batch-size 256 --calculate-loss --test-log-file results/correction/logs/test-log.csv\
      \ --raw-dataset data/raw/ICDAR2019_POCR_competition_dataset.zip --predictions-out-perfect-error-detection\
      \ results/correction/predictions-perfect-detection.csv --results-error-detection-model\
      \ results/detection/icdar_predictions.json --predictions-out-error-detection-model\
      \ results/correction/predictions-error-detection-model.csv --loglevel INFO\n"
    deps:
    - path: data/processed/correction-dataset/dataset.csv
      md5: 53c8c4d51c5641c39b824f8d485df4ee
      size: 85464812
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: results/detection/icdar_predictions.json
      md5: 1f1295ece1c46384f92aaa6fe1de2c7e
      size: 5172170
    - path: src/stages/predict-error-correction.py
      md5: d77a62194935e484d4eccdc6fc2d3ec3
      size: 7475
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        convert-predictions-to-icdar-output:
          icdar-output-json: results/detection/icdar_predictions.json
        create-error-correction-dataset:
          dataset: data/processed/correction-dataset/dataset.csv
        predict-error-correction:
          test-log: results/correction/logs/test-log.csv
          predictions-out-perfect-error-detection: results/correction/predictions-perfect-detection.csv
          predictions-out-error-detection-model: results/correction/predictions-error-detection-model.csv
        train-error-correction:
          max-len: 22
          batch-size: 256
          model-save-path: models/error-correction/model.rar
          hidden-size: 256
          dropout: 0.1
          teacher-forcing-ratio: 0.5
          num-epochs: 25
          valid-niter: 5
          max-num-patience: 5
          max-num-trial: 5
          lr-decay: 0.5
          train-log: results/correction/logs/train-log.csv
    outs:
    - path: results/correction/logs/test-log.csv
      md5: fc1875859fd563fd0f8b58b6c20daa89
      size: 31
    - path: results/correction/predictions-error-detection-model.csv
      md5: 10a626a9f99f342a34ba311672244f03
      size: 36434480
    - path: results/correction/predictions-perfect-detection.csv
      md5: 6f76f4d572a4d215112eff1c62ac5b24
      size: 37398698
  generate-perfect-icdar-json:
    cmd: python src/stages/generate-perfect-icdar-json.py --raw-dataset data/raw/ICDAR2019_POCR_competition_dataset.zip
      --out-file results/perfect/perfect-detection.json
    deps:
    - path: data/raw/ICDAR2019_POCR_competition_dataset.zip
      md5: 12de784f02a0dd99d1b3997674ee97f4
      size: 66523152
    - path: src/stages/generate-perfect-icdar-json.py
      md5: 709ecc053b4c36ad099b7747a70c88b0
      size: 1196
    params:
      params.yaml:
        base:
          loglevel: INFO
          seed: 8232
          raw-data-zip: data/raw/ICDAR2019_POCR_competition_dataset.zip
        generate-perfect-icdar-json:
          out-file: results/perfect/perfect-detection.json
    outs:
    - path: results/perfect/perfect-detection.json
      md5: 386921f65b5221fcd45ab48b5dece85c
      size: 5197896
